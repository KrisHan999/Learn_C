## 函数调用与内存分配

函数作为编程中实现功能的重要手段，深入理解函数的调用过程对提升开发能力有很大的帮助，首先了解一下两个任意函数之间进行调用的情形，与汇编程序设计中主程序和子程序之间的链接及信息交换类似，在高级语言编写的程序中（比如C语言），调用函数与被调用函数之间的链接及信息交换需要通过栈来进行。《C程序设计》一书中对于函数之间调用提出两个注意点：

> - **函数运行期间调用另外一个函数，在运行被调用函数之前，系统需要先完成3件事情:**

1. 将所有的**实参、返回地址**等信息传递给**被调用函数**保存
2. 为**被调用函数**局部变量在栈上**分配内存**
3. 将**控制转移**到被调用函数入口

- **被调用函数返回调用函数之前，系统也需要相应的完成3件事情:**
  1. 在**栈中保存**被调用函数的**计算结果**（返回值）
  2. **释放**在栈中为**被调用函数**分配的**数据区**
  3. 依照被调用函数保存的**返回地址将控制转移到调用函数**

当有多个函数嵌套调用时，按照**“后调用先返回”**的原则依次进行，看到这里想必大家一目了然，函数之间的调用规则和**“栈”**管理数据的方式完全相同，因此函数之间的信息传递和控制转移必须通过**“栈”**来实现。  
《数据结构(C语言版)》一书中对函数的调用过程在内存中的描述是这样的：

> 函数之间信息传递和控制转移必须通过“栈”来实现，即系统将整个程序运行所需的数据空间安排在一个栈中，每当调用一个函数就为它在栈顶分配一个存储区，每当从一个函数退出时，就释放它的存储区，当前正在运行的函数存储区必在栈顶。

- **帧栈**  

  帧栈也叫过程活动记录，是编译器用来实现过程/函数调用的一种数据结构。**每个栈帧对应着一个未运行完的函数**。栈帧中保存了该函数形参、返回地址、局部变量等信息。简而言之**栈帧就是一个函数执行的环境**。有时候函数嵌套调用，栈中会有多个函数的信息，每个函数占用一个连续的区域。引文中提到的**“存储区”**就是指一个函数对应的分配空间也就是一个**函数帧**。
- **参数的传递和内存分配**  

  被调用函数的形参，在未出现函数调用时不占用内存空间，发生函数调用时，形参按照确定的类型在该函数帧中被分配指定大小的空间。并且由调用函数的实参传递给被调用函数的形参保存。
- **函数具体调用过程：**
  1. 为被调用函数在栈顶分配空间，为被调用函数的形参分配空间
  2. 将实参的值传递给形参
  3. 被调用函数利用形参（如果存在）进行运算
  4. 通过`return`语句将返回值带回调用函数
  5. 调用结束，释放被调用函数空间，释放其形参分配空间

举个例子说明问题

```
int add(int num1, int num2) {
         int tempSum = num1 + num2;
         return tempSum;
}
int main(int argc, const char * argv[]) {
          int a = 10;
          int b = 20;
          int sum = add(a, b);
          printf("%i\n",sum); //   sum = 30
          return 0;
}
```

上面的`main()`、`add()`函数之间调用的过程及参数传递在内存的示意图如下：

![](./C语言-内存管理深入 - 简书_files/2474121-ae2c2383262a95a3.png)

函数调用参数分配示意图

（1）首先执行`main()`函数，系统为`main()`函数在栈顶分配一定大小的空间，其次为a、b局部变量分配空间；（2）调用`add()`函数，`main()`函数压入栈底，栈顶指针上移，系统为`add()`函数在栈顶分配一定大小的空间，其次为num1、num2局部变量分配空间；（3）执行两个整数的加法运算，在`add()`函数帧中新开辟一块空间存放计算后的结果tempSum；（4）最后`add()`函数返回，在`main()`函数帧中开辟一块新的空间存放`add()`函数的返回值sum，（5）`add()`函数帧调用结束出栈，系统释放其空间并且栈顶指针下移，`main()`函数重新回到栈顶。

**注意：当前正在运行的函数存储区必在栈顶。**

以上就是两个函数在调用过程中栈内存完整的工作情况（省略了`main()`函数形参的内存分配）。虽然函数在开发中无处不见，但是执行过程在内存中的表现形式还是有很多值得研究的。掌握其内存分配原理有助于我们更加深入理解函数。
